@using Appva.Mcss.Admin.Application.Common
@model Appva.Mcss.Admin.Models.DetailsMedicationModel

@Html.Partial("~/Areas/Patient/Features/Patient/Partials/_PatientDetails.cshtml", Model.Patient)
@Html.Partial("~/Features/Shared/_SubMenuPartial.cshtml", Model.Patient)

<div id="ehm">
    
    <h2>
        @if (Model.Medication.DiscontinuedAt.HasValue)
        {
            <span class="canceled">Utsatt - </span>
        }
        else if (Model.Medication.CanceledAt.HasValue)
        {
            <span class="canceled">Mackulerad - </span>
        }
        @Model.Medication.Article.Name 
        @if (Model.Medication.Type == Appva.Mcss.Admin.Domain.Entities.OrdinationType.Dispensed)
        {
            <span title="Dos-dispensierad" class="dos">DOS</span>
        }
        @if (Model.Medication.Type == Appva.Mcss.Admin.Domain.Entities.OrdinationType.NeedBased)
        {
            <span title="Vid behov" class="vb">VB</span>
        }
    </h2>
    <div class="row cf">
        
        <div class="e-panel col-2">
            
            @if (Model.Sequences.Sequence != null || (Model.Sequences.History != null && Model.Sequences.History.Count > 0))
            {
                var sequence = Model.Sequences.Sequence != null ? Model.Sequences.Sequence : Model.Sequences.History.FirstOrDefault();
                <h3 class="@(Model.Sequences.Sequence != null ? "sign-list-ok" : "sing-list-updated")">Signeringslista</h3>
                <p class="sign-list-summary">Insats på signeringslistan för <span class="schedule">@sequence.Schedule.ScheduleSettings.Name</span> är synkroniserad med ordinationen</p>
                <table class="compare-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Ordination</th>
                            <th>Insats på Signeringslista</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Namn</td>
                            <td>@Model.Medication.Article.Name</td>
                            <td>@sequence.Name</td>
                        </tr>
                        <tr>
                            <td>Ändamål/Instruktion</td>
                            <td>@Model.Medication.Purpose</td>
                            <td>@sequence.Description</td>
                        </tr>
                        <tr>
                            <td>Startar</td>
                            <td>@Model.Medication.OrdinationStartsAt.ToString("yyyy-MM-dd")</td>
                            <td>@sequence.StartDate.ToString("yyyy-MM-dd")</td>
                        </tr>
                        <tr>
                            <td>Slutar</td>
                            <td>@(Model.Medication.EndsAt.HasValue ? Model.Medication.EndsAt.Value.ToString("yyyy-MM-dd") : "Tills vidare" )</td>
                            <td>@(sequence.EndDate.HasValue ? sequence.EndDate.Value.ToString("yyyy-MM-dd") : "Tills vidare")</td>
                        </tr>
                        <tr>
                            <td>Dosering</td>
                            <td>
                                @if(Model.Medication.DosageScheme != null)
                                {
                                    Html.RenderPartial("_dosageScheme", Model.Medication.DosageScheme);
                                }
                                else
                                {
                                    @Model.Medication.DosageText
                                }
                            </td>
                            <td>
                                @if(sequence.OnNeedBasis)
                                {
                                    @:Vid behov
                                }
                                else
                                {
                                    @(Model.IntervallTranslation[sequence.Interval] + " " + string.Join(", ", sequence.Times.Split(',').Select(x => string.Format("kl {0}:00 +{1}min -{2}min", x, sequence.RangeInMinutesAfter, sequence.RangeInMinutesBefore))));
                                }
                                
                            </td>
                        </tr>
                       


                    </tbody>
                </table>
            }
            else
            {
                <h3>Signeringslista</h3>
                <div class="no-sequence">
                    <p>Detta läkemedel är ännu inte upplagt på en signeringslista</p>
                    @if (Model.Medication.Type != Appva.Mcss.Admin.Domain.Entities.OrdinationType.Dispensed)
                    {
                        @Html.ActionLink(Permissions.Sequence.Create, "+ Lägg till", "SelectSchedule", "Medication", new { OrdinationId = Model.Medication.OrdinationId, Id = Model.Patient.Id }, new { @class = "lb-link button add" })
                    }
                </div>
            }
            
        </div>
        <div class="e-panel col-2">
            <h3>Läkemedel</h3>
            <div class="info cf">
                <div class="param-box">
                    <label for="articleName">Namn</label>
                    <p name="articleName">@Model.Medication.Article.Name</p>
                </div>
                <div class="param-box">
                    <label for="articleForm">Läkemedelsform</label>
                    <p name="articleForm">@Model.Medication.Article.Form</p>
                </div>
                <div class="param-box">
                    <label for="articlePackageSize">Förpackningsstorlek</label>
                    <p name="articlePackageSize">@Model.Medication.Article.PackageSize @string.Format("{0}",Model.Medication.Article.PackageUnit)</p>
                </div>
                <div class="param-box">
                    <label for="articlePackageType">Förpackningstyp</label>
                    <p name="articlePackageType">@Model.Medication.Article.PackageType</p>
                </div>
            </div>
            <div class="info cf">
                <div class="param-box">
                    <label for="articleNplId">NplId</label>
                    <p name="articleNplId">@Model.Medication.Article.NplId</p>
                </div>
                <div class="param-box">
                    <label for="articleNplPackId">NplPackId</label>
                    <p name="articleNplPackId">@Model.Medication.Article.NplPackId</p>
                </div>
                <div class="param-box">
                    <label for="articleNumber">Artikelnummer</label>
                    <p name="articleNumber">@Model.Medication.Article.ArticleNumber</p>
                </div>
                <div class="param-box">
                    <label for="articleAtc">ATC</label>
                    <p name="articleAtc">@Model.Medication.Article.Atc</p>
                </div>
                <div class="param-box">
                    <label for="articleAtcCode">ATC-kod</label>
                    <p name="articleAtcCode">@Model.Medication.Article.AtcCode</p>
                </div>
            </div>
        </div>
        <div class="e-panel col-2">
            <h3>Ordination</h3>
            <div class="info cf">
                <h4>Allmänt</h4>
                <div class="param-box">
                    <label for="start">Insättning</label>
                    <p name="start">@Model.Medication.OrdinationStartsAt.ToString("yyyy-mm-dd")</p>
                </div>               
                <div class="param-box">
                    <label for="created">Ordinationstidpunkt</label>
                    <p name="created">@Model.Medication.OrdinationCreatedAt.ToString("yyyy-mm-dd")</p>
                </div>
                <div class="param-box">
                    <label for="valid">Giltig t.o.m</label>
                    <p name="valid">@Model.Medication.OrdinationValidUntil.GetValueOrDefault().ToString("yyyy-mm-dd")</p>
                </div>
                @if (Model.Medication.DiscontinuedAt.HasValue)
                {
                    <div class="param-box">
                        <label for="end">Utsatt</label>
                        <p name="origin-start">@Model.Medication.DiscontinuedAt.Value.ToString("yyyy-MM-dd")</p>
                    </div>
                }
                @if (Model.Medication.DiscontinuedComment.IsNotEmpty())
                {
                    <div class="param-box">
                        <label for="end">Utsatt kommentar</label>
                        <p name="origin-start">@Model.Medication.DiscontinuedComment</p>
                    </div>
                }
            </div>
            @if (Model.Medication.CanceledAt.HasValue)
            {
                <div class="info cf">
                    <div class="param-box">
                        <label for="text">Mackulerad</label>
                        <p name="text">@Model.Medication.CanceledAt.Value.ToString("yyyy-MM-dd")</p>
                    </div>
                    @if (Model.Medication.CancellationReason.IsNotEmpty())
                    {
                        <div class="param-box">
                            <label for="text">Mackuleringsorsak</label>
                            <p name="text">@Model.Medication.CancellationReason</p>
                        </div>
                    }
                    @if (Model.Medication.CancellationComment.IsNotEmpty())
                    {
                        <div class="param-box">
                            <label for="text">Mackuleringsorsak</label>
                            <p name="text">@Model.Medication.CancellationComment</p>
                        </div>
                    }
                    
                </div>
            }
            <div class="info cf">
                <div class="param-box">
                    <label for="text">Text till patienten</label>
                    <p name="text">@Model.Medication.DosageText</p>
                </div>
                <div class="param-box">
                    <label for="text">Ändamål</label>
                    <p name="text">@Model.Medication.Purpose</p>
                </div>
                @if (Model.Medication.DosageScheme != null)
                {
                    <div class="param-box large">
                        <label for="dosag se">Doseringsschema</label>
                        <div>
                            @{Html.RenderPartial("_dosageScheme", Model.Medication.DosageScheme);}
                        </div>
                    </div>
                }
            </div>
            <div class="info cf">
                <h4>Ordinatör</h4>
                <div class="param-box">
                    <label for="ordinator">Insatt av</label>
                    <p name="ordinator">
                        @Model.Medication.Prescriber.FullName
                    </p>
                </div>
                <div class="param-box">
                    <label for="workplace">Arbetsplats</label>
                    <p name="workplace">
                        @Model.Medication.Prescriber.WorkPlaceCode
                    </p>
                </div>
            </div>
            <div class="info cf">
                <h4>Expidition</h4>
                <div class="param-box">
                    <label for="ordinator">Återstående uttag</label>
                    <p name="ordinator">
                        @string.Format("{0} av {1}", Model.Medication.RemainingExpiditions.GetValueOrDefault(), Model.Medication.NumbersOfExpiditions.GetValueOrDefault())
                    </p>
                </div>
                <div class="param-box">
                    <label for="workplace">Senaste uttag</label>
                    <p name="workplace">
                        @if(Model.Medication.LastExpiditedAt.HasValue)
                        {
                            @Model.Medication.LastExpiditedAt.Value.ToString("yyyy-MM-dd")
                        }
                    </p>
                </div>
                @if (Model.Medication.LastExpiditedAmount.HasValue)
                {
                    <div class="param-box">
                        <label for="workplace">Senast uttagen mängd</label>
                        <p name="workplace">
                          
                                @Model.Medication.LastExpiditedAmount.Value
                            
                        </p>
                    </div>
                }
                @if (Model.Medication.LastExpiditedNplPackId.IsNotEmpty())
                {
                    <div class="param-box">
                        <label for="workplace">Senast uttaget NplPackId</label>
                        <p name="workplace">

                            @Model.Medication.LastExpiditedNplPackId

                        </p>
                    </div>
                }
            </div>
        </div>
    </div>
    
</div>