@model Appva.Mcss.Web.ViewModels.ScheduleReportViewModel
@using Appva.Mcss.Admin.Application.Common;
@{ ViewBag.Title = Localizer["Rapport"].ToString(); ViewBag.MainClass = "report-view"; }
@Html.Partial("~/Areas/Patient/Features/Patient/Partials/_PatientDetails.cshtml", Model.Patient)
    @Html.Partial("~/Features/Shared/_SubMenuPartial.cshtml", Model.Patient)
<div id="subheader" class="cf">
	<h1>@Localizer["Rapport"]</h1>
	    @using(Html.Post()) {
        <p class="filter">
            @Html.LabelFor(m => m.StartDate)
            @Html.EditorFor(m => m.StartDate)
            @Html.LabelFor(m => m.EndDate)
            @Html.EditorFor(m => m.EndDate)
            @Html.Submit(Localizer["Visa"].ToString())
        </p>
        }
	<a class="btn print" href="#">@Localizer["Skriv_ut"]</a>
   @Html.ActionLink(Localizer["Exportera_till_Excel"].ToString(), "Excel", "Schedule", new { Id = Model.Patient.Id, ScheduleSettingsId = Model.Schedule, StartDate = Model.StartDate, EndDate = Model.EndDate }, new { @class = "export" })

</div>
<div id="content" class="has-nav cf">
    <ul id="nav-sub">
        @if (Model.Schedules.IsNotNull()) {
            <li class="@(!Model.Schedule.HasValue ? "sel" : "")">
                @Html.ActionLink(Localizer["Alla"].ToString(), "ScheduleReport", new { Id = Model.Patient.Id, StartDate = Model.StartDate.ToShortDateString(), EndDate = Model.EndDate.ToShortDateString() })
            </li>
            foreach (var schedule in Model.Schedules) {
                <li class="@(Model.Schedule.HasValue && Model.Schedule.Value.Equals(schedule.Id) ? "sel" : "")">
                    @Html.ActionLink(schedule.Name, "ScheduleReport", new { id = Model.Patient.Id, scheduleSettingsId = schedule.Id, startDate = Model.StartDate.ToShortDateString(), endDate = Model.EndDate.ToShortDateString() })
                </li>
            }
        }
	</ul>
	<div id="content-primary">
        <div id="report" class="cf">
            <div id="chart" class="chart" style="height: 250px; margin-bottom:20px;"></div>

			@Html.Partial("/Features/Statistics/Data/StatisticsData.cshtml", Model.Report)

            @if (Model.Tasks.Entities.Count > 0) {
            <div id="signed-events" class="listing">
			    <h2 class="heading">@Localizer["Insatser_under_perioden"]</h2>
                <table>
				    <thead>
					    <tr class="head">
						    <th scope="col">@Localizer["Gavs"]</th>
						    <th scope="col">@Localizer["Dag"]</th>
						    <th scope="col">@Localizer["Tid"]</th>
						    <th scope="col">@Localizer["Skulle_ges"]</th>
                            <th scope="col">@Localizer["Boende"]</th>
                            <th scope="col">@Localizer["Signerat_av"]</th>
						    <th scope="col">@Localizer["Status"]</th>
					    </tr>
				    </thead>
				    <tbody>
                        @foreach (var task in Model.Tasks.Entities) {
    <tr class="@(!task.IsActive ? "modified" : "") @((task.Delayed || (task.Status > 1 && task.Status < 5) || (task.StatusTaxon.IsNotNull() ? task.StatusTaxon.Weight > 1 : false)) ? "alarm" : "")">
						    <td>@task.Name</td>
						    <td>
                                @if (task.OnNeedBasis) {
                                    @TimeSpanDifference.ToShortDateTime(task.UpdatedAt, Localizer["Idag"].ToString(), Localizer["Igår"].ToString())
                                } else {
                                    if (!task.IsCompleted) {
                                        @:-
                                    }
                                    else {
                                        @TimeSpanDifference.ToShortDateTime(task.CompletedDate.GetValueOrDefault(), Localizer["Idag"].ToString(), Localizer["Igår"].ToString())
                                    }
                                }
                            </td>
						    <td>
                                @if (task.Delayed && task.CompletedBy.IsNull()) {
                                    @:Ej signerad
                                } else {
                                    if (task.OnNeedBasis) {
										@:kl @String.Format("{0:HH:mm}", task.UpdatedAt)
									} else {
                                        @:kl @String.Format("{0:HH:mm}", task.CompletedDate.GetValueOrDefault())
									}
                                }
                            </td>
						    <td>
                                @TimeSpanDifference.ToShortDateTime(task.Scheduled, Localizer["Idag"].ToString(), Localizer["Igår"].ToString()) kl @String.Format("{0:HH:mm}", task.Scheduled)
                                @if (task.RangeInMinutesBefore.Equals(task.RangeInMinutesAfter)) {
                                    @:±@task.RangeInMinutesBefore min
                                }
            else {
                                    @:+@task.RangeInMinutesAfter -@task.RangeInMinutesBefore min
                                }
                            </td>
                            <td>
                                @task.Patient.FullName
                            </td>
                            <td>
                                @if (task.CompletedBy.IsNotNull()) {
                                    @task.CompletedBy.FullName
            }
            else {
                                    @:--
                                }
                            </td>
                            <td>
            @if (task.StatusTaxon != null) {
                                    <img src="@Url.Image(task.StatusTaxon.Path)" alt="@task.StatusTaxon.Name" />
                if (task.Delayed && task.StatusTaxon.Weight < 2) {
                                        <strong>@Localizer["Avvikelse_"]</strong> @Localizer["{0}_för_sent", task.StatusTaxon.Name]
                                    }
                else if (task.StatusTaxon.Weight > 1) {
                                        <strong>@Localizer["Avvikelse_"]</strong> @task.StatusTaxon.Name
                                    }
                else {
                                        @task.StatusTaxon.Name
                                    }
                                }
            else {
                if (task.Status.Equals(1)) {
                                        <img src="@Url.Image("icn-ok.png")" alt="OK" />
                                        if (task.Delayed) {
                                            <strong>@Localizer["Avvikelse_"]</strong> @Localizer["Given_för_sent"]
                                        }
                    else {
                                            @:OK
                                        }
                }
                else if (task.Status.Equals(2)) {
                                        <img src="@Url.Image("icn-part.png")" alt="Delvis given" />
                                        <strong>@Localizer["Avvikelse_"]</strong> @Localizer["Delvis_given"]
                                    }
                else if (task.Status.Equals(3)) {
                                        <img src="@Url.Image("icn-none.png")" alt="Ej given" />
                                        <strong>@Localizer["Avvikelse_"]</strong> @Localizer["Ej_given"]
                                    }
                else if (task.Status.Equals(4)) {
                                        <img src="@Url.Image("icn-nothx.png")" alt="Kan ej ta" />
                                        <strong>@Localizer["Avvikelse_"]</strong> @Localizer["Kan_ej_ta"]
                                    }
                else if (task.Status.Equals(5)) {
                                        <img src="@Url.Image("icn-sent.png")" alt="Medskickad" /> @Localizer["Medskickad"]
                                    }
                else if (task.Status.Equals(6)) {
                                        <img src="@Url.Image("icn-none.png")" alt="Larm" />
                                        <strong>@Localizer["Avvikelse_"]</strong> @Localizer["Räknad_mängd_stämmer_ej_med_saldo"]
                                    }
                else {
                                        if (task.Delayed) {
                                            <img src="@Url.Image("icn-alarm.png")" alt="Larm" />
                                            <strong>@Localizer["Avvikelse_"]</strong>
                                            if (task.DelayHandled)
                                            {
                                                if (Html.HasPermissionFor(Permissions.Alert.Read))
                                                {
                                                    @Html.ActionLink(Localizer["Larm_åtgärdat"].ToString(), "List", "Alerts", new { Area = "patient", id = task.Patient.Id }, null)
                                                }
                                                else
                                                {
                                                    @Localizer["Larm_åtgärdat"]
                                                }
                                            }
                                            else
                                            {
                                                @Localizer["Ej_given"]
                                            }
                                        }
                                    }
                                }
                                
                            </td>
					    </tr>
                        }
				    </tbody>
			    </table>
		    </div>
            @Html.Pager((int)Model.Tasks.PageSize, (int)Model.Tasks.CurrentPage, (int)Model.Tasks.TotalCount).Options(o => o
                .DisplayTemplate("Pagination")
                .MaxNrOfPages(15)
                .AlwaysAddFirstPageNumber()
                .AddRouteValue("scheduleSettingsId", Model.Schedule)
                .AddRouteValue("startDate", Model.StartDate.ToShortDateString())
                .AddRouteValue("endDate", Model.EndDate.ToShortDateString())
                )
            }
        </div>
    </div>
</div>
<script type="text/javascript">
    $(function () {
        Date.format = 'yyyy-mm-dd';
        $('.datepick').datePicker({
            'startDate': '1970-01-01',
            'clickInput': true
        });
        $('#subheader form').validate({
            'rules': {
                'StartDate': {
                    'date': true,
                    'datelessthan': [$('#EndDate')]
                },
                'EndDate': {
                    'date': true,
                    'dategreaterthan': [$('#StartDate')]
                }
            },
            'messages': {
                'StartDate': {
                    'date': "@Localizer["Datum_måste_fyllas_i_med_åtta_siffror_och_bindestreck__t__ex__2012-12-21"]",
                    'datelessthan': "@Localizer["Startdatum_måste_vara_ett_tidigare_datum_är_slutdatum"]"
                },
                'EndDate': {
                    'date': "@Localizer["Datum_måste_fyllas_i_med_åtta_siffror_och_bindestreck__t__ex__2012-12-21"]",
                    'dategreaterthan': "@Localizer["Slutdatum_måste_vara_ett_senare_datum_är_startdatum"]"
                }
            }
        });
        mcss.chart.Load({
            'selector': '#chart',
            'url': '@Url.Action("GetChartData", "Statistics", new { area = "" })',
            'min': new Date(@Model.StartDate.Year, @(Model.StartDate.Month - 1), @Model.StartDate.Day),
            'max': new Date(@Model.EndDate.Year, @(Model.EndDate.Month - 1), @Model.EndDate.Day),
            'parameters': {
                'Patient': '@Model.Patient.Id',
                'ScheduleSetting': '@Model.Schedule',
                'Start': '@Model.StartDate.ToShortDateString()',
                'End': '@Model.EndDate.ToShortDateString()'
            }
        });

    });
</script>